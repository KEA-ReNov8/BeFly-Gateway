name: Deploy to On-Premise via FortiGate VPN

# developì— pushì‹œ workflow ìƒì„±
on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install openfortivpn
        run: sudo apt-get update && sudo apt-get install -y openfortivpn

      # 3. FortiGate VPN ì—°ê²°
      - name: Connect to FortiGate VPN
        run: |
          sudo mkdir -p /var/log/openfortivpn
          sudo touch /var/log/openfortivpn/vpn.log
          sudo chmod 666 /var/log/openfortivpn/vpn.log

          echo "ðŸ” Connecting to FortiGate VPN..."

          # VPN ì—°ê²° ì‹œìž‘ (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰)
          sudo openfortivpn ${{ secrets.VPN_SERVER }}:${{ secrets.VPN_PORT }} \
            -u ${{ secrets.VPN_USERNAME }} \
            -p "${{ secrets.VPN_PASSWORD }}" \
            --no-dns \
            --no-routes \
            --trusted-cert=${{ secrets.VPN_CERT }} \
            >> /var/log/openfortivpn/vpn.log 2>&1 &

          # ìž ì‹œ ëŒ€ê¸°
          sleep 10

          echo "ðŸ“¡ VPN ì—°ê²° ë¡œê·¸:"
          tail -n 20 /var/log/openfortivpn/vpn.log

          # ì‹¤íŒ¨ ì—¬ë¶€ ì²´í¬
          if grep -q "ERROR" /var/log/openfortivpn/vpn.log || ! pgrep openfortivpn > /dev/null; then
            echo "âŒ FortiGate VPN ì—°ê²° ì‹¤íŒ¨. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          else
            echo "âœ… VPN ì—°ê²° ì„±ê³µ."
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: make application.yml
        run: |
            cd ./src/main
            mkdir -p resources
            cd resources
            
            touch ./application.yml
            echo "${{ secrets.APPLICATION_YML }}" >> ./application.yml

      # 1-2. application-dev.yml íŒŒì¼ ìƒì„±
      - name: make application-dev.yml
        run: |
              cd ./src/main
              cd ./resources
            
              touch ./application-dev.yml
              echo "${{ secrets.APPLICATION_DEV_YML }}" >> ./application-dev.yml

      - name: Build with Gradle
        run: |
            chmod +x ./gradlew 
            ./gradlew clean build -x test

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/befly-gateway:latest .

      - name: Push to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/befly-gateway:latest
          
      - name: Connect SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            docker pull kohyunchoel/befly-gateway:latest
            
            docker stop befly-gateway || true
            docker rm befly-gateway || true
        
            docker run -d --name befly-gateway \
            -p 8000:8000 \
            kohyunchoel/befly-gateway:latest




    
